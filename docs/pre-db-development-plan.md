# Pre-DB Development Plan

## Scope
- 対象期間はデータベース導入までのフロントエンド／バックエンド開発。
- 永続化は導入せず、モック／インメモリ実装で機能要件を検証する。
- 1stリリース想定フロー（ルーム作成→共有→参加→投票→ランキング）の画面とAPI契約を揃える。

## マイルストーン
- **M0 (〜2025-10-24)**: 既存Todo実装整理、ドメイン構造とAPI契約のプロト定義。
- **M1 (2025-10-27〜2025-11-01)**: バックエンドモックAPI実装・状態管理（インメモリ）・非同期ジョブ疑似化。
- **M2 (2025-11-04〜2025-11-12)**: フロントエンド主要画面実装・API接続・状態遷移ハンドリング。
- **M3 (2025-11-13〜2025-11-20)**: 結合テスト・UX調整・DB導入準備（スキーマドラフト、モック→DB移行計画）。

## バックエンドタスク
- **初期セットアップ**
  - `server/index.ts:1` 等にあるTodoルーターを撤去し、`rooms`, `members`, `restaurants`, `likes` などドメイン別ルーターへ再構成。
  - `docs/API.md`の契約に基づき型定義（TypeScript interface）とレスポンスラッパーを用意。
- **インメモリ実装**
  - ルーム／メンバー／候補／投票の各リポジトリをメモリ内マップで表現し、`room_code`をキーに CRUD を提供。
  - 非同期準備ジョブを擬似的に `setTimeout` ベースで実装し、状態遷移（`waiting`→`voting`）と進捗を模倣。
- **APIルーティング**
  - `/rooms` 作成・設定更新・取得、`/members` 追加／一覧／セッション発行、`/restaurants` カード取得、`/likes` 投票・一覧・リセット、`/ranking` 集計の各エンドポイントを揃える。
  - JWT発行と検証はプレーンな署名検証で実装し、期限切れ・権限エラーをレスポンス化。
- **テスト**
  - Vitest + Supertest でインメモリAPIの主要ユースケースを自動化（正常系／権限エラー／状態遷移ガード）。
  - 非同期準備ジョブは時間短縮パラメータを設け、テスト内で完了確認。
- **DB導入準備**
  - `docs/Table.md` を元に Drizzle スキーマドラフトを `server/db/schema.ts` などに作成（実際のマイグレーションは保留）。
  - インメモリリポジトリと同じインターフェースで DB リポジトリを実装する計画書きを追加し、差し替え容易にする。

## フロントエンドタスク
- **設計**
  - 画面構成：ルーム作成、共有／参加、投票、ランキング、投票管理の各ページコンポーネントを `src/features` 配下に整理。
  - 状態管理：React Query もしくは独自 fetch ラッパで API 呼び出しとポーリング（`waiting`→`voting`）を管理。
- **UI実装**
  - 既存 Todo UI を除去し、Tailwind v4 ベースでワイヤに沿ったコンポーネントを実装。
  - QR 表示はモックデータ（文字列）で実装、DB導入後に正式URLを連携。
  - 投票カードはダミー画像・テキストを使用し、`カ―ド尽き`状態、詳細モーダル、スワイプ操作（ボタン操作中心）を整える。
- **API統合**
  - インメモリAPIと通信し、レスポンス型を `docs/API.md` と一致させる。
  - JWT の保存（メモリ or sessionStorage）と再取得フローを実装。
  - エラーハンドリング：`waiting` 中の 425 応答をリトライ秒数に変換し、ユーザへ表示。
- **テスト**
  - コンポーネント単体テスト（投票カード、ランキングリスト）、React Testing Library と Vitestで実施。
  - E2E 事前準備として Playwright シナリオ草案をドキュメント化（実装はDB導入フェーズで本格化）。

## 結合・レビュー
- API/フロントの contract test を設定し、OpenAPIモックと比較。
- Swagger UI や Storybook はオプションだが、デザインレビューを容易にするため `docs/Tutorial.md` にアクセス手順を追記予定。
- デモ環境（Docker Compose）でインメモリ構成を立ち上げ、チームレビュー会を週次開催。

## リスクと対策
- Places API / 要約未接続によるデータ不足 → フェイクデータジェネレータを準備し、UI／API の整合性を維持。
- 状態遷移の複雑化 → 状態マシン図を `docs/sequence.md` と合わせて更新し、レビュー時共有。
- インメモリ実装から DB への移行リスク → Repository インターフェースとサービス層を分離し、モック→実DBの差し替えを `TODO` コメントで明示。

## 期待成果物
- インメモリAPI含むバックエンドコード、主要フロント画面、契約テスト、テストレポート（M3時点）。
- DBスキーマドラフトと移行手順書（着手はするがマイグレーション未実行）。
