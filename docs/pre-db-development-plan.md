# Pre-DB Development Plan

## Scope
- 対象期間はデータベース導入までのフロントエンド／バックエンド開発。
- 永続化は導入せず、モック／インメモリ実装で機能要件を検証する。
- 1stリリース想定フロー（ルーム作成→共有→参加→投票→ランキング）の画面とAPI契約を揃える。

## マイルストーン
- **M0 (〜2025-10-24)**: 既存Todo実装整理、ドメイン構造とAPI契約のプロト定義。
- **M1 (2025-10-27〜2025-11-01)**: バックエンドモックAPI実装・状態管理（インメモリ）・非同期ジョブ疑似化。
- **M2 (2025-11-04〜2025-11-12)**: フロントエンド主要画面実装・API接続・状態遷移ハンドリング。
- **M3 (2025-11-13〜2025-11-20)**: 結合テスト・UX調整・DB導入準備（スキーマドラフト、モック→DB移行計画）。

## バックエンドタスク
- **初期セットアップ**
  - `server/index.ts:1` 等にあるTodoルーターを撤去し、`rooms`, `members`, `restaurants`, `likes` などドメイン別ルーターへ再構成。
  - `docs/API.md`の契約に基づき型定義（TypeScript interface）とレスポンスラッパーを用意。
- **インメモリ実装**
  - ルーム／メンバー／候補／投票の各リポジトリをメモリ内マップで表現し、`room_code`をキーに CRUD を提供。
  - 非同期準備ジョブを擬似的に `setTimeout` ベースで実装し、状態遷移（`waiting`→`voting`）と進捗を模倣。
- **APIルーティング**
  - `/rooms` 作成・設定更新・取得、`/members` 追加／一覧／セッション発行、`/restaurants` カード取得、`/likes` 投票・一覧・リセット、`/ranking` 集計の各エンドポイントを揃える。
  - JWT発行と検証はプレーンな署名検証で実装し、期限切れ・権限エラーをレスポンス化。
- **テスト**
  - Vitest + Supertest で API 統合テスト（`tests/api/**/*.test.ts`）を整備し、`pnpm test:api`（推奨: `docker compose run --rm app pnpm test:api`）で実行可能にする。
  - 非同期準備ジョブは時間短縮パラメータを設け、テスト内で完了確認。
- **DB導入準備**
  - `docs/Table.md` を元に Drizzle スキーマドラフトを `server/db/schema.ts` などに作成（実際のマイグレーションは保留）。
  - インメモリリポジトリと同じインターフェースで DB リポジトリを実装する計画書きを追加し、差し替え容易にする。

## フロントエンドタスク
- **設計**
  - 画面構成：ルーム作成、共有／参加、投票、ランキング、投票管理の各ページコンポーネントを `src/features` 配下に整理。
  - 状態管理：React Query もしくは独自 fetch ラッパで API 呼び出しとポーリング（`waiting`→`voting`）を管理。
- **UI実装**
  - 既存 Todo UI を除去し、Tailwind v4 ベースでワイヤに沿ったコンポーネントを実装。
  - QR 表示はモックデータ（文字列）で実装、DB導入後に正式URLを連携。
  - 投票カードはダミー画像・テキストを使用し、`カ―ド尽き`状態、詳細モーダル、スワイプ操作（ボタン操作中心）を整える。
- **API統合**
  - インメモリAPIと通信し、レスポンス型を `docs/API.md` と一致させる。
  - JWT の保存（メモリ or sessionStorage）と再取得フローを実装。
  - エラーハンドリング：`waiting` 中の 425 応答をリトライ秒数に変換し、ユーザへ表示。
- **テスト**
  - コンポーネント単体テスト（投票カード、ランキングリスト）、React Testing Library と Vitestで実施。
  - E2E 事前準備として Playwright シナリオ草案をドキュメント化（実装はDB導入フェーズで本格化）。

## 結合・レビュー
- API/フロントの contract test を設定し、OpenAPIモックと比較。
- Swagger UI や Storybook はオプションだが、デザインレビューを容易にするため `docs/Tutorial.md` にアクセス手順を追記予定。
- デモ環境（Docker Compose）でインメモリ構成を立ち上げ、チームレビュー会を週次開催。

## リスクと対策
- Places API / 要約未接続によるデータ不足 → フェイクデータジェネレータを準備し、UI／API の整合性を維持。
- 状態遷移の複雑化 → 状態マシン図を `docs/sequence.md` と合わせて更新し、レビュー時共有。
- インメモリ実装から DB への移行リスク → Repository インターフェースとサービス層を分離し、モック→実DBの差し替えを `TODO` コメントで明示。

## 期待成果物
- インメモリAPI含むバックエンドコード、主要フロント画面、契約テスト、テストレポート（M3時点）。
- DBスキーマドラフトと移行手順書（着手はするがマイグレーション未実行）。

---

## フォローアップ計画（共有URL対応〜DB導入直前まで）

### M3.1 (2025-11-21〜2025-11-27) 共有導線と参加UXの強化
- **共有URLルーティング**
  - `src` に React Router を導入し、`/dashboard`（幹事用）、`/r/:roomCode`（参加用）レイアウトを切り分け。
  - `vite.config.ts`／`server/index.ts` に `historyApiFallback` を設定し、任意パスでも SPA を返却。
  - `APP_SHARE_BASE_URL` を `.env.example` に追記し、ローカルでは `http://localhost:5173` を指すよう調整。
- **参加フローUI**
  - `src/features/participation` を新設。ルーム参照→メンバー選択→トークン発行→投票開始までを 3 ステップフォームで実装。
  - 425 応答時のローディングステータスと再試行ボタンを統一デザインで表示。
  - QR/リンク共有カードをダッシュボードに追加し、コピー・再生成のアクションを整理。
- **APIバリデーション**
  - `server/routes/rooms.ts` のリクエスト Body/Query を zod で検証し、`error.details` にフィールド情報を付与。
  - 設定更新時の値チェック（緯度経度範囲、価格帯0-4等）を追加。
- **テスト更新**
  - Supertest で `GET /rooms/:code` (waiting/voting) と `POST /members` バリデーション系をカバーし、`pnpm test:api` のシナリオに追加。
  - Playwright シナリオ：`/dashboard` でルーム作成→`/r/:code` 参加→投票→ランキング確認まで自動化。

### M3.2 (2025-11-28〜2025-12-05) 非同期処理／運用想定の整備
- **準備ジョブの高度化**
  - `server/store.ts` の `schedulePreparation` をサービス層へ抽出し、再準備時の前段キャンセルと進捗ステップを設定化。
  - 進捗イベントをログ出力し、バックエンドの状態を `pino` 等で可視化（実際のキュー導入時に移行しやすくする）。
- **ランキング・投票体験改善**
  - 投票カードの残枚数表示、投票済みリストの閲覧モーダル（`GET /likes` 利用）を追加。
  - ランキングパネルで一定間隔（例: 5秒）ポーリングし、更新があればトースト通知。
- **操作ログ／エラーハンドリング**
  - サーバー側で共通ロガーを導入し、room_code・member_id を含めた構造化ログを出力。
  - フロントは `useErrorBoundary` 相当のハンドラを整備し、API失敗時のメッセージをコンポーネント化。
- **ドキュメント更新**
  - `docs/Tutorial.md` に新規画面（URL共有カード、参加フロー）と操作手順 GIF/スクリーンショットを追加。
  - `docs/sequence.md` で `/r/:roomCode` アクセス時のシーケンスを追記。

### M3.3 (2025-12-08〜2025-12-13) DB置き換え準備の最終化
- **リポジトリ抽象化**
  - `server/store.ts` のデータアクセスを `repositories/rooms.ts` 等に分離し、インターフェースを通じて利用。
  - Drizzle スキーマ（Room/Setting/Member/Like/RoomRestaurant/Restaurant/Rating）を `server/db/schema.ts` に定義、`drizzle-kit` の `sql` ファイル生成までは実行。
- **差し替え手順書**
  - インメモリ実装からDB実装へ移行する際の手順を `docs/pre-db-development-plan.md` に追加（環境変数、マイグレーション、初期データ投入）。
  - テスト切り替え方針（DB接続をMockに差し替えるなど）を `tests/README.md` として整備。
- **品質ゲート**
  - APIテストをCIで自動実行し、フォーマット／型チェック（`pnpm lint`, `pnpm typecheck`）と合わせてPre-DBフェーズの最終ゲートを完成。
  - パフォーマンス試験の準備として、ロードテストスクリプト（k6 などの雛形）を `scripts/loadtest` に配置。

### 成果サマリ（M3.3終了時点）
- 共有URLで参加できるモック体験、管理・参加双方のUI整備、主要ユースケースの自動テスト。
- インメモリ実装を抽象化し、Drizzleスキーマ・マイグレーション準備が整った状態。
- ドキュメント（Tutorial/Sequence/Plan）と手順書が更新され、DB導入フェーズへ即移行可能。

## 実装進捗メモ（2025-10-18 時点）
- `src/App.tsx` のルーティングを実装し、`/` は幹事ダッシュボード、`/r/:roomCode` は参加者ビューとして分離。
- 参加者ビューでは既存メンバー選択 or 新規登録→トークン発行→投票→ランキング確認のフローを提供。
- `APP_SHARE_BASE_URL` が未設定の場合でも開発環境では `http://localhost:5173/r/{code}` が発行されるようサーバー側を調整。
- 既存UIはカスタムCSSベースへ移行済み（Tailwind v4 依存を排除）。
